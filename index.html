<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DAW Audio Engine</title>
</head>
<body style="background:#111;color:white;font-family:sans-serif;padding:20px">

<h1>DAW Step Sequencer</h1>

<input id="tempo" type="number" value="120" style="width:60px;"> BPM
<button id="startBtn">Start Engine</button>
<button id="playSeq">Play/Stop</button>

<!-- Sequencer Grid -->
<div id="grid" style="display:grid;grid-template-columns:repeat(17,40px);gap:4px;margin-top:20px;"></div>

<script>
// -----------------------------------------
// AUDIO ENGINE CORE
// -----------------------------------------

let audioCtx;
let masterGain;

let tracks = [];
let loadedOpen = null;
let loadedClosed = null;
let loadedSnare = null;

// ðŸ”¥ Replace these with the actual file paths
const openHatPath = "808-OpenHat.wav";
const closedHatPath = "808-ClosedHat.wav";
const snarePath = "808-Snare.wav";

function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1;
    masterGain.connect(audioCtx.destination);
}

function createTrack() {
    const gain = audioCtx.createGain();
    const pan = audioCtx.createStereoPanner();
    gain.connect(pan);
    pan.connect(masterGain);

    const track = { gain, pan };
    tracks.push(track);
    return track;
}

async function loadAudio(url) {
    const res = await fetch(url);
    const data = await res.arrayBuffer();
    return await audioCtx.decodeAudioData(data);
}

function playBuffer(buffer, time) {
    const track = tracks[0];
    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.connect(track.gain);
    source.start(time);
}

// -----------------------------------------
// STEP SEQUENCER GRID (3 rows x 16 cols)
// -----------------------------------------

const steps = [
    new Array(16).fill(0), // Open Hat
    new Array(16).fill(0), // Closed Hat
    new Array(16).fill(0)  // Snare
];

const grid = document.getElementById("grid");

function buildGrid() {
    grid.innerHTML = "";

    const labels = ["OH", "CH", "Snare"];

    for (let r = 0; r < 3; r++) {
        const label = document.createElement("div");
        label.textContent = labels[r];
        label.style.marginRight = "10px";
        grid.appendChild(label);

        for (let c = 0; c < 16; c++) {
            const cell = document.createElement("div");
            cell.style.width = "40px";
            cell.style.height = "40px";
            cell.style.border = "1px solid #333";
            cell.style.cursor = "pointer";
            cell.style.display = "flex";
            cell.style.alignItems = "center";
            cell.style.justifyContent = "center";

            if ((c % 4) === 0) cell.style.borderLeft = "3px solid #555";

            cell.dataset.row = r;
            cell.dataset.col = c;

            cell.onclick = () => {
                steps[r][c] = steps[r][c] ? 0 : 1;
                cell.style.background = steps[r][c] ? "#0f0" : "transparent";
            };

            grid.appendChild(cell);
        }
    }
}

buildGrid();

// -----------------------------------------
// PLAYHEAD + CLOCK
// -----------------------------------------

let isPlaying = false;
let currentStep = 0;
let nextNoteTime = 0;
let lookahead = 25;      
let scheduleAhead = 0.1;

function nextStep() {
    let tempo = parseFloat(document.getElementById("tempo").value);
    let secPerBeat = 60 / tempo;
    nextNoteTime += secPerBeat / 4; // 16th
    currentStep = (currentStep + 1) % 16;
}

function scheduleStep(step, time) {
    const allCells = grid.querySelectorAll("div");
    allCells.forEach(cell => cell.style.outline = "none");

    for (let r = 0; r < 3; r++) {
        let idx = r * 17 + (step + 1);
        allCells[idx].style.outline = "2px solid red";
    }

    if (steps[0][step] === 1) playBuffer(loadedOpen, time);
    if (steps[1][step] === 1) playBuffer(loadedClosed, time);
    if (steps[2][step] === 1) playBuffer(loadedSnare, time);
}

function scheduler() {
    while (nextNoteTime < audioCtx.currentTime + scheduleAhead) {
        scheduleStep(currentStep, nextNoteTime);
        nextStep();
    }
    if (isPlaying) setTimeout(scheduler, lookahead);
}

// -----------------------------------------
// BUTTONS
// -----------------------------------------

document.getElementById("startBtn").onclick = async () => {
    if (!audioCtx) initAudio();
    createTrack();

    loadedOpen = await loadAudio(openHatPath);
    loadedClosed = await loadAudio(closedHatPath);
    loadedSnare = await loadAudio(snarePath);

    alert("Engine ready. All samples loaded.");
};

document.getElementById("playSeq").onclick = () => {
    if (!loadedOpen || !loadedClosed || !loadedSnare) {
        alert("Start engine first.");
        return;
    }

    isPlaying = !isPlaying;

    if (isPlaying) {
        currentStep = 0;
        nextNoteTime = audioCtx.currentTime + 0.1;
        scheduler();
    }
};
</script>

</body>
</html>
